# Task 4: SSH Key Lifecycle Manager

## Parallel Group: A

## Dependencies: None

## Description

Build the SSH key lifecycle manager at `packages/server/src/aws/ssh-keys.ts`. This module handles generation of ephemeral ed25519 key pairs, uploading them to S3, downloading the private key (one-time delivery), and cleaning them up on termination. SSH keys are generated by shelling out to the system `ssh-keygen` binary (per locked-in decision: no ssh2 npm package). S3 storage uses the existing `@aws-sdk/client-s3` client already in the server package.

### Interface

```typescript
// packages/server/src/aws/ssh-keys.ts

export interface SshKeyPair {
  publicKey: string;    // OpenSSH format public key
  privateKey: string;   // PEM-encoded ed25519 private key
}

export interface SshKeyManagerDeps {
  s3Client: FuelCodeS3Client;  // existing S3 client from Phase 1
  logger: pino.Logger;
}

export class SshKeyManager {
  constructor(deps: SshKeyManagerDeps);

  // Generate an ephemeral ed25519 SSH key pair.
  // Shells out to: ssh-keygen -t ed25519 -f <tmpdir>/id_ed25519 -N "" -q -C "fuel-code-<remoteEnvId>"
  // Reads both files into memory. Cleans up temp files (even on error, via try/finally).
  // Returns the key pair as strings.
  async generateKeyPair(remoteEnvId: string): Promise<SshKeyPair>;

  // Upload both keys to S3.
  // Paths: ssh-keys/{remoteEnvId}/id_ed25519 and ssh-keys/{remoteEnvId}/id_ed25519.pub
  // Uses AES256 server-side encryption.
  // Returns the S3 key prefix (ssh-keys/{remoteEnvId}/).
  async uploadKeyPair(remoteEnvId: string, keyPair: SshKeyPair): Promise<string>;

  // Download private key from S3. Returns the key string.
  // Called by the SSH key download API endpoint.
  async downloadPrivateKey(remoteEnvId: string): Promise<string>;

  // Delete both keys from S3. Called on environment termination.
  // Idempotent — does not throw if keys are already deleted.
  async deleteKeyPair(remoteEnvId: string): Promise<void>;
}
```

### Key Generation Details

The generator uses `Bun.spawn` to shell out to `ssh-keygen`:

```typescript
const tmpDir = path.join(os.tmpdir(), `fuel-code-ssh-${remoteEnvId}-${Date.now()}`);
await fs.mkdir(tmpDir, { recursive: true });
const keyPath = path.join(tmpDir, 'id_ed25519');

try {
  const proc = Bun.spawn([
    'ssh-keygen', '-t', 'ed25519',
    '-f', keyPath,
    '-N', '',          // empty passphrase
    '-q',              // quiet mode
    '-C', `fuel-code-${remoteEnvId}`,  // comment for identification
  ]);
  const exitCode = await proc.exited;
  if (exitCode !== 0) throw new Error(`ssh-keygen failed with exit code ${exitCode}`);

  const privateKey = await Bun.file(keyPath).text();
  const publicKey = await Bun.file(`${keyPath}.pub`).text();
  return { publicKey: publicKey.trim(), privateKey };
} finally {
  // Always clean up temp directory
  await fs.rm(tmpDir, { recursive: true, force: true });
}
```

### S3 Paths

Following CORE.md's layout:
- Private key: `ssh-keys/{remote_env_id}/id_ed25519`
- Public key: `ssh-keys/{remote_env_id}/id_ed25519.pub`

Both uploaded with `ServerSideEncryption: 'AES256'` and `ContentType: 'text/plain'`.

### Relevant Files

**Create:**
- `packages/server/src/aws/ssh-keys.ts`
- `packages/server/src/aws/__tests__/ssh-keys.test.ts`

**Modify:**
- `packages/server/src/aws/index.ts` — export `SshKeyManager`

### Tests

`ssh-keys.test.ts` (bun:test):

1. `generateKeyPair` produces valid ed25519 key pair — private key starts with `-----BEGIN OPENSSH PRIVATE KEY-----`, public key starts with `ssh-ed25519`.
2. `generateKeyPair` includes the remote env ID in the key comment.
3. Temp directory is cleaned up after successful key generation.
4. Temp directory is cleaned up even when an error occurs (mock ssh-keygen failure).
5. Temp directory uses unique name (includes remoteEnvId + timestamp) to avoid conflicts with concurrent generation.
6. `uploadKeyPair` uploads both files to correct S3 paths: `ssh-keys/{id}/id_ed25519` and `ssh-keys/{id}/id_ed25519.pub`.
7. `uploadKeyPair` uses AES256 server-side encryption.
8. `uploadKeyPair` returns the S3 key prefix.
9. `downloadPrivateKey` retrieves the private key from S3 at the correct path.
10. `downloadPrivateKey` returns the raw key string.
11. `deleteKeyPair` deletes both keys from S3.
12. `deleteKeyPair` is idempotent — does not throw on missing keys (S3 DeleteObject is already idempotent).
13. S3 client methods are called with correct bucket, key, and options.

### Success Criteria

1. `generateKeyPair` produces valid ed25519 keys by shelling out to `ssh-keygen` via `Bun.spawn`.
2. Generated keys are cleaned up from the temp directory after reading (even on error).
3. `uploadKeyPair` stores keys at the correct S3 paths with server-side encryption.
4. `downloadPrivateKey` returns the raw private key string from S3.
5. `deleteKeyPair` removes both keys from S3 and does not throw on missing keys.
6. Temporary files use unique names (remoteEnvId + timestamp) to avoid conflicts.
7. Key comment includes the remote env ID for identification.
8. Uses existing S3 client — no new S3 dependency needed.
