# Task 1: Version Stamping & Build Info

## parallel-group: A
## depends-on: none
## blocks: T2, T5

---

## Description

Create the foundational version stamping system. A build-time script generates a TypeScript file with git SHA, branch, and timestamp. A stable import module provides these values at runtime with a dev-mode fallback. The CLI `--version` flag, `status` command, and server health endpoint all use this build info.

This task also changes the server's default PORT from 3000 to 3020 (per design decision) and fixes `.gitignore` so `.env.example` is not ignored.

---

## Relevant Files

### Create

**`scripts/stamp-version.ts`** — Bun script that generates build metadata.

The `scripts/` directory does not exist and must be created.

```typescript
#!/usr/bin/env bun
/**
 * Version stamp script — generates packages/shared/src/build-info.generated.ts.
 *
 * Reads git SHA, branch, and timestamp. Writes a TypeScript module that exports
 * BUILD_INFO. Supports env var overrides for Docker builds where .git is unavailable.
 *
 * Priority for SHA resolution:
 *   1. GIT_SHA env var (explicit override, used in Docker build args)
 *   2. RAILWAY_GIT_COMMIT_SHA env var (Railway auto-sets this during builds)
 *   3. `git rev-parse HEAD` (local dev / CI)
 *   4. "unknown" (final fallback)
 *
 * Usage:
 *   bun run scripts/stamp-version.ts                     # local dev
 *   GIT_SHA=abc123 bun run scripts/stamp-version.ts      # Docker build
 */
import { join } from "node:path";

const OUTPUT_PATH = join(import.meta.dir, "..", "packages", "shared", "src", "build-info.generated.ts");

function exec(cmd: string[]): string {
  try {
    const result = Bun.spawnSync(cmd, { stdout: "pipe", stderr: "pipe" });
    return result.stdout.toString().trim();
  } catch {
    return "";
  }
}

// Resolve git metadata with fallback chain
const commitSha =
  process.env.GIT_SHA ||
  process.env.RAILWAY_GIT_COMMIT_SHA ||
  exec(["git", "rev-parse", "HEAD"]) ||
  "unknown";

const commitShort =
  process.env.GIT_SHORT ||
  (commitSha !== "unknown" && commitSha.length >= 7 ? commitSha.slice(0, 7) : commitSha) ||
  "unknown";

const branch =
  process.env.GIT_BRANCH ||
  process.env.RAILWAY_GIT_BRANCH ||
  exec(["git", "rev-parse", "--abbrev-ref", "HEAD"]) ||
  "unknown";

const buildDate = process.env.BUILD_DATE || new Date().toISOString();

const content = `// AUTO-GENERATED by scripts/stamp-version.ts — do not edit
export const BUILD_INFO = {
  commitSha: ${JSON.stringify(commitSha)},
  commitShort: ${JSON.stringify(commitShort)},
  buildDate: ${JSON.stringify(buildDate)},
  branch: ${JSON.stringify(branch)},
} as const;
`;

await Bun.write(OUTPUT_PATH, content);
console.log(`Stamped: ${commitShort} (${branch}) at ${buildDate}`);
```

---

**`packages/shared/src/build-info.ts`** — Stable import with dev-mode fallback.

This is an ESM package (`"type": "module"`). `require()` will NOT work. Uses top-level `await import()` which is valid in ESM and fully supported by Bun.

```typescript
/**
 * Build metadata — git SHA, build timestamp, branch.
 *
 * In production (after `bun run stamp`), exports values from the generated file.
 * In development (no stamp), exports safe defaults so the app never crashes.
 *
 * Uses top-level await + dynamic import to handle the missing generated file gracefully.
 * The .js extension in the import path is required by moduleResolution: "bundler".
 */

export interface BuildInfo {
  readonly commitSha: string;
  readonly commitShort: string;
  readonly buildDate: string;
  readonly branch: string;
}

const DEV_BUILD_INFO: BuildInfo = {
  commitSha: "development",
  commitShort: "dev",
  buildDate: new Date().toISOString(),
  branch: "unknown",
};

let _resolved: BuildInfo = DEV_BUILD_INFO;
try {
  const mod = await import("./build-info.generated.js");
  _resolved = mod.BUILD_INFO;
} catch {
  // Generated file doesn't exist — running in dev mode, use defaults
}

export const BUILD_INFO: BuildInfo = _resolved;
```

---

### Modify

**`packages/shared/src/index.ts`** — Add BUILD_INFO re-export.

After the last export line (line 29 `export * from "./errors.js"`), add:

```typescript
// Build metadata (git SHA, build date, branch)
export * from "./build-info.js";
```

This makes `BUILD_INFO` and `BuildInfo` importable from `@fuel-code/shared`.

---

**`packages/cli/src/index.ts`** — Change version from hardcoded to BUILD_INFO.

1. Add import at the top (after existing imports, around line 42):
   ```typescript
   import { BUILD_INFO } from "@fuel-code/shared";
   ```

2. Line 107, change:
   ```typescript
   .version("0.1.0")
   ```
   to:
   ```typescript
   .version(`${BUILD_INFO.commitShort} (${BUILD_INFO.buildDate.split("T")[0]})`)
   ```

   This produces: `fuel-code dev (2026-02-28)` in dev, or `fuel-code abc1234 (2026-02-28)` after stamping.

---

**`packages/cli/src/commands/status.ts`** — Add version line to formatStatus output.

1. Add import:
   ```typescript
   import { BUILD_INFO } from "@fuel-code/shared";
   ```

2. In `formatStatus()` (starts at line 279), after `lines.push("")` (line 282) and before the Device line (line 285), insert:
   ```typescript
   lines.push(`  Version:    ${BUILD_INFO.commitShort} (${BUILD_INFO.buildDate.split("T")[0]}, ${BUILD_INFO.branch})`);
   ```

   Result:
   ```
   fuel-code status

     Version:    abc1234 (2026-02-28, main)
     Device:     MacBook-Pro (a1b2c3d4...)
     ...
   ```

---

**`packages/server/src/routes/health.ts`** — Replace hardcoded VERSION with BUILD_INFO.

1. Add import at top:
   ```typescript
   import { BUILD_INFO } from "@fuel-code/shared";
   ```

2. Remove line 19:
   ```typescript
   const VERSION = "0.1.0";
   ```

3. Line 79, change:
   ```typescript
   version: VERSION,
   ```
   to:
   ```typescript
   version: `${BUILD_INFO.commitShort} (${BUILD_INFO.buildDate.split("T")[0]})`,
   ```

   The `version` field stays a string. This avoids breaking the CLI's `HealthStatus` interface (`version: string` at `packages/cli/src/lib/api-client.ts:144`). No HealthStatus type change needed.

---

**`packages/server/src/index.ts`** — Change PORT default from 3000 to 3020.

Line 70, change:
```typescript
PORT: parseInt(process.env.PORT || "3000", 10),
```
to:
```typescript
PORT: parseInt(process.env.PORT || "3020", 10),
```

---

**`package.json` (root)** — Add stamp script.

Add to `scripts` object:
```json
"stamp": "bun run scripts/stamp-version.ts"
```

---

**`.gitignore`** — Add generated file + fix .env.example visibility.

1. Add `build-info.generated.ts` (after the existing `dist/` line):
   ```
   build-info.generated.ts
   ```

2. After the `.env.*` line (line 5), add:
   ```
   !.env.example
   ```

   This is needed because `.env.*` matches `.env.example`, which would prevent Task 3 from committing `.env.example`. The `!` prefix un-ignores it.

---

### Read (for context)

- `packages/shared/src/index.ts` — existing exports pattern
- `packages/cli/src/index.ts` — current `.version("0.1.0")` on line 107
- `packages/cli/src/commands/status.ts` — `formatStatus()` at line 279
- `packages/server/src/routes/health.ts` — `VERSION = "0.1.0"` on line 19
- `packages/server/src/index.ts` — PORT default on line 70
- `packages/cli/src/lib/api-client.ts` — `HealthStatus` interface at line 138 (stays unchanged)

---

## Success Criteria

### Happy Path
- `bun run stamp` creates `packages/shared/src/build-info.generated.ts` containing the current git SHA, short SHA, branch, and an ISO build date.
- `bun run packages/cli/src/index.ts --version` outputs `abc1234 (2026-02-28)` (with actual SHA and date) after stamping.
- `fuel-code status` output includes `Version:    abc1234 (2026-02-28, main)` as the first data line.
- `GET /api/health` response includes `version: "abc1234 (2026-02-28)"` (string format).
- Server listens on port 3020 by default (without PORT env var set).
- `import { BUILD_INFO } from "@fuel-code/shared"` works from cli, server, and core packages.

### Dev Mode (no stamp)
- Without running stamp, `bun run packages/cli/src/index.ts --version` outputs `dev (YYYY-MM-DD)`. **No crash.**
- `fuel-code status` shows `Version:    dev (YYYY-MM-DD, unknown)`.
- Health endpoint returns `version: "dev (YYYY-MM-DD)"`.

### Docker Build Args (T2 integration)
- `GIT_SHA=abc123full GIT_SHORT=abc123f GIT_BRANCH=main BUILD_DATE=2026-01-01T00:00:00Z bun run stamp` uses all env var overrides, does NOT call git.
- `RAILWAY_GIT_COMMIT_SHA=abc123full RAILWAY_GIT_BRANCH=main bun run stamp` uses Railway env vars as fallback.
- If `GIT_SHA` is set but git is not available, the script succeeds (no git calls needed).

### Edge Cases
- `build-info.generated.ts` is listed in `.gitignore` — `git status` does not show it as untracked after stamping.
- `.env.example` is NOT matched by `.gitignore` (the `!.env.example` exception works).
- Existing tests pass. If `packages/cli/src/commands/__tests__/status.test.ts` has assertions on `formatStatus()` output, the new `Version:` line may cause test failures. Update those test assertions.
- If the existing `api-client.test.ts` has a mock `version: "1.0.0"` in the health response (line 553), it should still work since `version` stays a string.

### Negative Tests
- Running stamp in a directory with no `.git` and no env overrides: script writes `"unknown"` values, does NOT crash.
- Importing `BUILD_INFO` when `build-info.generated.ts` has invalid syntax: fallback to dev defaults, no crash.
