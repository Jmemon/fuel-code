name: CI

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  typecheck:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"
      - run: bun install --frozen-lockfile
      - run: bun run typecheck

  test:
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: fuel_code_test
          POSTGRES_USER: test
          POSTGRES_PASSWORD: test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U test"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      redis:
        image: redis:7-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd="redis-cli ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
      localstack:
        image: localstack/localstack:latest
        env:
          SERVICES: s3
          DEFAULT_REGION: us-east-1
        ports:
          - 4566:4566
    steps:
      - uses: actions/checkout@v4
      - uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.5"
      - run: bun install --frozen-lockfile
      - run: bun test
        env:
          DATABASE_URL: postgresql://test:test@localhost:5432/fuel_code_test
          REDIS_URL: redis://localhost:6379
          API_KEY: test-key
          S3_BUCKET: test-bucket
          S3_REGION: us-east-1
          S3_ENDPOINT: http://localhost:4566
          S3_FORCE_PATH_STYLE: "true"
          AWS_ACCESS_KEY_ID: test
          AWS_SECRET_ACCESS_KEY: test

  docker-build:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4
      - run: |
          docker build \
            --build-arg GIT_SHA=${{ github.sha }} \
            --build-arg GIT_SHORT=$(echo ${{ github.sha }} | cut -c1-7) \
            --build-arg GIT_BRANCH=${{ github.ref_name }} \
            --build-arg BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ) \
            -t fuel-code .
